<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<title>KonOpas Configurator</title>

<body>

<style>
.filters { white-space: pre-wrap; }
#reset, #result, #results { display: none; }
.config-results #reset, .config-results #results { display: block; }
.config-results form { display: none; }
</style>

<h1>KonOpas Configurator</h1>

<form id="form">
<p>Please enter the URL for the file containing your <kbd> var program = [...];</kbd> definition:</p>
<input type="text" id="url0" size="80" placeholder="http://..."><br>
<input type="submit" value="Generate sample HTML for filters">
</form>

<input type="button" id="reset" value="Reset">

<div id="results">
<div id="program">
<h3>Initial filters to use for your <i>Program</i> view:</h3>
<pre id="program-filters" class="filters">Loading...</pre>
</div>

<div id="people">
<h3>Initial filters to use for your <i>People</i> view:</h3>
<pre id="people-filters" class="filters">Loading...</pre>
</div>
</div>

<script>
var program = false, people = false;


function unique(value, index, self) { return self.indexOf(value) === index; }
function weekday(t) { return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][t.getDay()]; }

function parse_program() {
	if (!program || !program.length) return null;
	var r = [];

	var days = program.map(function(p) { return p.date; }).filter(unique);
	if (days.length) {
		days.sort();
		r.push('<ul id="day">');
		r.push('<li id="all_days">All days');
		r = r.concat.apply(r, days.map(function(d) { return '<li id="d' + d + '">' + weekday(new Date(d)); }));
		r.push('</ul>');
	}

	var area_levels = Math.max.apply(null, program.map(function(p) { return p.loc && p.loc.length || 0; }));
	var areas = [];
	var areas_counted = {};
	for (var i = 0; i < area_levels; ++i) {
		areas.push(program.map(function(p) { return p.loc && p.loc[i] || ''; }).filter(unique));
		areas[i].sort();
	}
	for (var i = 0; i < areas.length; ++i) {
		r.push('');
		r.push('<ul id="area">');
		r.push('<li id="all_areas">Everywhere');
		r = r.concat.apply(r, areas[i].map(function(a) { return '<li id="' + a + '">' + a; }));
		r.push('</ul>');
	}

	var tags = [].concat.apply([], program.map(function(p) { return p.tags || []; })).filter(unique);
	if (tags.length) {
		tags.sort();
		r.push('');
		r.push('<ul id="tag">');
		r.push('<li id="all_tags">All tags');
		r = r.concat.apply(r, tags.map(function(t) { return '<li id="' + t + '">' + t; }));
		r.push('</ul>');
	}

	return r.join('\n');
}

function parse_people() {
	if (!people || !people.length) return null;
	return null;
}


function load_script(url) {
	var script = document.createElement('script');
	script.src = url;

	var done = false;
	script.onload = script.onreadystatechange = function() {
		if (!done && (!this.readyState || this.readyState === "loaded" || this.readyState === "complete")) {
			done = true;
			script.onload = script.onreadystatechange = null;
			if (script && script.parentNode) { script.parentNode.removeChild(script); }

			document.getElementById('program-filters').textContent = parse_program() || '[No program data found]';
			document.getElementById('people-filters').textContent = parse_people() || '[No people data found]';
		}
	};
	document.getElementsByTagName('head')[0].appendChild(script);
}


document.getElementById('form').onsubmit = function(ev) {
	document.location.hash = '#' + document.getElementById('url0').value;
	(ev || window.event).preventDefault();
};

document.getElementById('reset').onclick = function() { document.location.hash = ''; };


function init() {
	if (document.location.hash.length > 1) {
		document.body.classList.add('config-results');
		load_script(document.location.hash.substr(1));
	} else {
		document.body.classList.remove('config-results');
		document.getElementById('program-filters').textContent = 'Loading...';
		document.getElementById('people-filters').textContent = 'Loading...';
	}
}
window.onhashchange = init;
init();
</script>
